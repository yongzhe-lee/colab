# Colab 프로젝트 아키텍처 설계

## 1. 프로젝트 개요

온프레미스 환경에서 안전하게 Python 코드를 실행할 수 있는 Django 기반 개발 환경 제공 시스템

### 1.1 목적
- Framework에서 사용자 Python 코드 개발환경 제공
- Framework DB 연결로 사용자 맞춤형 데이터 핸들링 환경 제공
- 템플릿 제공으로 쉬운 Python 개발환경 제공

### 1.2 핵심 요구사항
- **안전성**: 온프레미스 환경에서 안전한 Python 코드 실행
- **격리**: 외부 라이브러리 사용 제한 및 위험 함수 차단
- **성능**: 빠른 응답 시간 및 최적화된 리소스 사용
- **확장성**: 템플릿 기반 개발 환경 확장 가능

## 2. 시스템 아키텍처

### 2.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web UI     │  │  API Client  │  │  Mobile App  │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                  │               │
│         └─────────────────┼──────────────────┘               │
│                           │ JSON API                          │
└───────────────────────────┼───────────────────────────────────┘
                            │
┌───────────────────────────┼───────────────────────────────────┐
│                    Django Application Layer                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Django REST Framework (DRF)              │   │
│  │  - 코드 실행 API                                      │   │
│  │  - 템플릿 관리 API                                    │   │
│  │  - 파일 관리 API                                      │   │
│  │  - 사용자 인증/권한 관리                              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Business Logic Layer                      │   │
│  │  - 코드 실행 서비스                                    │   │
│  │  - 템플릿 서비스                                       │   │
│  │  - 파일 관리 서비스                                    │   │
│  │  - DB 연결 서비스                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┼───────────────────────────────────┘
                            │
┌───────────────────────────┼───────────────────────────────────┐
│                    Execution Layer                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Python Execution Engine                       │   │
│  │  ┌────────────────┐  ┌────────────────┐             │   │
│  │  │ RestrictedPython│  │  Docker Isolated│             │   │
│  │  │   (기본)       │  │   (고급 보안)   │             │   │
│  │  └────────────────┘  └────────────────┘             │   │
│  │                                                       │   │
│  │  허용 라이브러리:                                     │   │
│  │  - numpy, pandas, sklearn, matplotlib                │   │
│  │  - Framework DB 연결 모듈                            │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┼───────────────────────────────────┘
                            │
┌───────────────────────────┼───────────────────────────────────┐
│                    Data Layer                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Framework DB │  │  File Storage│  │  Code Cache  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────────────────────────────────────────────┘
```

### 2.2 컴포넌트 상세

#### 2.2.1 Client Layer
- **Web UI**: React/Vue.js 기반 웹 인터페이스
- **API Client**: RESTful API를 통한 통신
- **데이터 형식**: JSON 기반 통신

#### 2.2.2 Django Application Layer
- **Django REST Framework**: API 엔드포인트 제공
- **인증/권한**: Django 인증 시스템 활용
- **미들웨어**: 요청 검증, 로깅, 보안 헤더

#### 2.2.3 Execution Layer
- **RestrictedPython**: 기본 실행 환경 (경량, 빠른 응답)
- **Docker**: 고급 보안이 필요한 경우 격리 실행
- **라이브러리 제한**: 화이트리스트 기반 허용 라이브러리 관리

#### 2.2.4 Data Layer
- **Framework DB**: 기존 Framework 데이터베이스 연결
- **File Storage**: 사용자 코드 및 결과 파일 저장
- **Code Cache**: 실행 결과 캐싱 (성능 최적화)

## 3. 보안 아키텍처

### 3.1 코드 실행 보안

#### 3.1.1 RestrictedPython (기본 모드)
- **장점**: 경량, 빠른 실행, 낮은 리소스 사용
- **보안 기능**:
  - 위험한 함수 차단 (open, eval, exec, import 등)
  - 허용된 모듈만 import 가능
  - 파일 시스템 접근 제한
  - 네트워크 접근 제한

#### 3.1.2 Docker 격리 (고급 모드)
- **장점**: 완전한 격리, 최고 수준의 보안
- **특징**:
  - 컨테이너별 리소스 제한 (CPU, 메모리)
  - 네트워크 격리
  - 파일 시스템 격리
  - 타임아웃 설정

### 3.2 라이브러리 관리

#### 허용 라이브러리 화이트리스트
```python
ALLOWED_MODULES = [
    'numpy',
    'pandas',
    'sklearn',
    'matplotlib',
    'scipy',
    'framework_db',  # Framework DB 연결 모듈
]
```

#### 제한 사항
- 외부 패키지 설치 불가
- 네트워크 요청 제한
- 파일 시스템 쓰기 제한 (임시 디렉토리만 허용)

### 3.3 인증 및 권한

- Django 인증 시스템 활용
- 사용자별 코드 실행 권한 관리
- 세션 기반 인증
- API 토큰 인증 (선택)

## 4. API 설계

### 4.1 코드 실행 API

```
POST /api/v1/execute/
Request:
{
    "code": "print('Hello World')",
    "execution_mode": "restricted" | "docker",
    "timeout": 30
}

Response:
{
    "status": "success" | "error",
    "output": "...",
    "error": "...",
    "execution_time": 0.123
}
```

### 4.2 템플릿 API

```
GET /api/v1/templates/
Response:
[
    {
        "id": 1,
        "name": "그리드 조회",
        "category": "data",
        "code": "..."
    },
    ...
]

GET /api/v1/templates/{id}/
POST /api/v1/templates/
```

### 4.3 파일 관리 API

```
GET /api/v1/files/
POST /api/v1/files/
GET /api/v1/files/{id}/
PUT /api/v1/files/{id}/
DELETE /api/v1/files/{id}/
```

### 4.4 DB 연결 API

```
POST /api/v1/db/query/
Request:
{
    "query": "SELECT * FROM table",
    "params": {}
}

Response:
{
    "data": [...],
    "columns": [...],
    "row_count": 100
}
```

## 5. 데이터 모델

### 5.1 주요 모델

- **User**: 사용자 정보
- **CodeFile**: 사용자 코드 파일
- **Template**: 템플릿 정보
- **ExecutionLog**: 실행 로그
- **ExecutionResult**: 실행 결과 캐시

## 6. 성능 최적화

### 6.1 캐싱 전략
- 코드 실행 결과 캐싱 (동일 코드 재실행 시)
- 템플릿 목록 캐싱
- DB 쿼리 결과 캐싱

### 6.2 비동기 처리
- 장시간 실행 코드는 비동기 처리
- Celery를 활용한 작업 큐 관리

### 6.3 리소스 관리
- 실행 시간 제한
- 메모리 사용량 제한
- 동시 실행 수 제한

## 7. 배포 아키텍처

### 7.1 온프레미스 배포

```
┌─────────────────────────────────────┐
│         Load Balancer                │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Django │  │Django │  │Django │
│App 1  │  │App 2  │  │App 3  │
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────▼──────────┐
    │   Shared Storage     │
    │  - File Storage      │
    │  - Redis (Cache)     │
    └──────────────────────┘
               │
    ┌──────────▼──────────┐
    │   Framework DB       │
    └──────────────────────┘
```

### 7.2 Docker 실행 환경 (선택)

```
┌─────────────────────────────────────┐
│      Docker Execution Pool           │
│  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │Container│  │Container│  │Container│ │
│  │   1     │  │   2     │  │   3     │ │
│  └────────┘  └────────┘  └────────┘ │
└─────────────────────────────────────┘
```

## 8. 모니터링 및 로깅

- 실행 로그 기록
- 에러 추적
- 성능 메트릭 수집
- 사용자 활동 로깅

## 9. 확장 계획

### 9.1 단계별 구현
1. **Phase 1**: 기본 Django 구조 + RestrictedPython 실행
2. **Phase 2**: 템플릿 시스템 + 파일 관리
3. **Phase 3**: Framework DB 연결
4. **Phase 4**: Docker 격리 실행 (선택)
5. **Phase 5**: 고급 기능 (비동기 실행, 결과 캐싱)

### 9.2 향후 고도화
- Jupyter Kernel Gateway 통합 (상태 유지 실행)
- 사용자 메뉴 등록 기능
- 협업 기능
- 버전 관리

